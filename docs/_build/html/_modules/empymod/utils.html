<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>empymod.utils &#8212; empymod 1.0.dev documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '1.0.dev',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="empymod 1.0.dev documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for empymod.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">:mod:`utils` -- Utilites</span>
<span class="sd">========================</span>

<span class="sd">This module consists of four groups of functions:</span>
<span class="sd">   0. General Settings</span>
<span class="sd">   1. Class EMArray</span>
<span class="sd">   2. Input parameter checks for modelling</span>
<span class="sd">   3. General utilities</span>

<span class="sd">Group 0 is to set minimum offset, frequency and time for calculation (in order</span>
<span class="sd">to avoid divisions by zero).  Group 2 are checks organised in modules. So if</span>
<span class="sd">you create for instance a modelling-routine in which you loop over frequencies,</span>
<span class="sd">you have to call `check_ab`, `check_param`, `check_spatial`, and `check_hankel`</span>
<span class="sd">only once, but `check_frequency` in each loop. You do not have to run these</span>
<span class="sd">checks if you are sure your input parameters are in the correct format.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># Copyright 2016 Dieter Werthm√ºller</span>
<span class="c1">#</span>
<span class="c1"># This file is part of `empymod`.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not</span>
<span class="c1"># use this file except in compliance with the License.  You may obtain a copy</span>
<span class="c1"># of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span>
<span class="c1"># WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.  See the</span>
<span class="c1"># License for the specific language governing permissions and limitations under</span>
<span class="c1"># the License.</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">timeit</span> <span class="k">import</span> <span class="n">default_timer</span>
<span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="k">import</span> <span class="n">mu_0</span>       <span class="c1"># Magn. permeability of free space [H/m]</span>
<span class="kn">from</span> <span class="nn">scipy.constants</span> <span class="k">import</span> <span class="n">epsilon_0</span>  <span class="c1"># Elec. permittivity of free space [F/m]</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">filters</span><span class="p">,</span> <span class="n">transform</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;EMArray&#39;</span><span class="p">,</span> <span class="s1">&#39;fem_input&#39;</span><span class="p">,</span> <span class="s1">&#39;tem_input&#39;</span><span class="p">,</span> <span class="s1">&#39;check_ab&#39;</span><span class="p">,</span> <span class="s1">&#39;check_param&#39;</span><span class="p">,</span>
           <span class="s1">&#39;check_spatial&#39;</span><span class="p">,</span> <span class="s1">&#39;check_hankel&#39;</span><span class="p">,</span> <span class="s1">&#39;check_frequency&#39;</span><span class="p">,</span> <span class="s1">&#39;check_opt&#39;</span><span class="p">,</span>
           <span class="s1">&#39;check_time&#39;</span><span class="p">,</span> <span class="s1">&#39;strvar&#39;</span><span class="p">,</span> <span class="s1">&#39;param_shape&#39;</span><span class="p">,</span> <span class="s1">&#39;printstartfinish&#39;</span><span class="p">,</span> <span class="p">]</span>

<span class="c1"># 0. Settings</span>

<span class="n">min_off</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">3</span>    <span class="c1"># Minimum offset     [m]</span>
<span class="n">min_freq</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">20</span>  <span class="c1"># Minimum frequency  [Hz]</span>
<span class="n">min_time</span> <span class="o">=</span> <span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">20</span>  <span class="c1"># Minimum time       [s]</span>


<span class="c1"># 1. Class EMArray</span>

<div class="viewcode-block" id="EMArray"><a class="viewcode-back" href="../../empymod.html#empymod.utils.EMArray">[docs]</a><span class="k">class</span> <span class="nc">EMArray</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Subclassing an ndarray: add *Amplitude* &lt;amp&gt; and *Phase* &lt;pha&gt;.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    realpart : array</span>
<span class="sd">        1. Real part of input, if input is real or complex.</span>
<span class="sd">        2. Imaginary part of input, if input is pure imaginary.</span>
<span class="sd">        3. Complex input.</span>

<span class="sd">        In cases 2 and 3, `imagpart` must be None.</span>

<span class="sd">    imagpart: array, optional</span>
<span class="sd">        Imaginary part of input. Defaults to None.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    amp : ndarray</span>
<span class="sd">        Amplitude of the input data.</span>
<span class="sd">    pha : ndarray</span>
<span class="sd">        Phase of the input data, in degrees, lag-defined (increasing with</span>
<span class="sd">        increasing offset.) To get lead-defined phases, multiply `imagpart` by</span>
<span class="sd">        -1 before passing through this function.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from empymod.utils import EMArray</span>
<span class="sd">    &gt;&gt;&gt; emvalues = EMArray(np.array([1,2,3]), np.array([1, 0, -1]))</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;Amplitude : &#39;, emvalues.amp)</span>
<span class="sd">    Amplitude :  [ 1.41421356  2.          3.16227766]</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;Phase     : &#39;, emvalues.pha)</span>
<span class="sd">    Phase     :  [ 45.           0.         -18.43494882]</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">realpart</span><span class="p">,</span> <span class="n">imagpart</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new EMArray.&quot;&quot;&quot;</span>

        <span class="c1"># Create complex obj</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">imagpart</span><span class="p">):</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">realpart</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imagpart</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">realpart</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">complex</span><span class="p">)</span>

        <span class="c1"># Ensure its at least a 1D-Array, view cls</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

        <span class="c1"># Store amplitude</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">amp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># Calculate phase, unwrap it, transform to degrees</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">pha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">rad2deg</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unwrap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">real</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">obj</span><span class="o">.</span><span class="n">imag</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">obj</span></div>


<span class="c1"># 2. Input parameter checks for modelling</span>

<div class="viewcode-block" id="fem_input"><a class="viewcode-back" href="../../empymod.html#empymod.utils.fem_input">[docs]</a><span class="k">def</span> <span class="nf">fem_input</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">aniso</span><span class="p">,</span> <span class="n">epermH</span><span class="p">,</span> <span class="n">epermV</span><span class="p">,</span> <span class="n">mpermH</span><span class="p">,</span>
              <span class="n">mpermV</span><span class="p">,</span> <span class="n">xdirect</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">verb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide correct input for frequency-domain EM calculation.</span>

<span class="sd">    This check-function is called from one of the modelling routines in</span>
<span class="sd">    :mod:`model`.  Consult these modelling routines for a description of the</span>
<span class="sd">    input parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outdata : tuple</span>
<span class="sd">        Tuple containing the correct input format for :mod:`model.fem`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check src-rec configuration</span>
    <span class="c1"># =&gt; Get flags if src or rec or both are magnetic (msrc, mrec)</span>
    <span class="n">ab_calc</span><span class="p">,</span> <span class="n">msrc</span><span class="p">,</span> <span class="n">mrec</span> <span class="o">=</span> <span class="n">check_ab</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">verb</span><span class="p">)</span>

    <span class="c1"># Check layer parameters</span>
    <span class="n">param</span> <span class="o">=</span> <span class="n">check_param</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">aniso</span><span class="p">,</span> <span class="n">epermH</span><span class="p">,</span> <span class="n">epermV</span><span class="p">,</span> <span class="n">mpermH</span><span class="p">,</span> <span class="n">mpermV</span><span class="p">,</span>
                        <span class="n">verb</span><span class="p">)</span>
    <span class="n">depth</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">aniso</span><span class="p">,</span> <span class="n">epermH</span><span class="p">,</span> <span class="n">epermV</span><span class="p">,</span> <span class="n">mpermH</span><span class="p">,</span> <span class="n">mpermV</span><span class="p">,</span> <span class="n">isfullspace</span> <span class="o">=</span> <span class="n">param</span>

    <span class="c1"># Check src and rec</span>
    <span class="c1"># =&gt; Get source and receiver depths (zsrc, zrec)</span>
    <span class="c1"># =&gt; Get layer number in which src and rec reside (lsrc/lrec)</span>
    <span class="c1"># =&gt; Get x- and y-coordinates, offsets, angles (xco, yco, off, angle)</span>
    <span class="n">spatial</span> <span class="o">=</span> <span class="n">check_spatial</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">verb</span><span class="p">)</span>
    <span class="n">zsrc</span><span class="p">,</span> <span class="n">zrec</span><span class="p">,</span> <span class="n">lsrc</span><span class="p">,</span> <span class="n">lrec</span><span class="p">,</span> <span class="n">xco</span><span class="p">,</span> <span class="n">yco</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">angle</span> <span class="o">=</span> <span class="n">spatial</span>

    <span class="c1"># Check Hankel transform parameters</span>
    <span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span> <span class="o">=</span> <span class="n">check_hankel</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">verb</span><span class="p">)</span>

    <span class="c1"># Check frequency</span>
    <span class="c1"># =&gt; Get etaH, etaV, zetaH, and zetaV</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">check_frequency</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">aniso</span><span class="p">,</span> <span class="n">epermH</span><span class="p">,</span> <span class="n">epermV</span><span class="p">,</span> <span class="n">mpermH</span><span class="p">,</span>
                                <span class="n">mpermV</span><span class="p">,</span> <span class="n">verb</span><span class="p">)</span>
    <span class="n">freq</span><span class="p">,</span> <span class="n">etaH</span><span class="p">,</span> <span class="n">etaV</span><span class="p">,</span> <span class="n">zetaH</span><span class="p">,</span> <span class="n">zetaV</span> <span class="o">=</span> <span class="n">frequency</span>

    <span class="c1"># Check optimization</span>
    <span class="n">optimization</span> <span class="o">=</span> <span class="n">check_opt</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span><span class="p">,</span> <span class="n">verb</span><span class="p">)</span>
    <span class="n">use_spline</span><span class="p">,</span> <span class="n">use_ne_eval</span><span class="p">,</span> <span class="n">loop_freq</span><span class="p">,</span> <span class="n">loop_off</span> <span class="o">=</span> <span class="n">optimization</span>

    <span class="c1"># Print calculation related info</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ab_calc</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">36</span><span class="p">,</span> <span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;  &lt;ab&gt; IS &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ab_calc</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; WHICH IS ZERO; returning&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">isfullspace</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;  MODEL IS A FULLSPACE; returning analytical &quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;frequency-domain solution&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">isfullspace</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;  CALCULATING MODEL&quot;</span><span class="p">)</span>

    <span class="c1"># Arrange outdata-tuple</span>
    <span class="n">outdata</span> <span class="o">=</span> <span class="p">(</span><span class="n">ab_calc</span><span class="p">,</span> <span class="n">xco</span><span class="p">,</span> <span class="n">yco</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">zsrc</span><span class="p">,</span> <span class="n">zrec</span><span class="p">,</span> <span class="n">lsrc</span><span class="p">,</span> <span class="n">lrec</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span>
               <span class="n">freq</span><span class="p">,</span> <span class="n">etaH</span><span class="p">,</span> <span class="n">etaV</span><span class="p">,</span> <span class="n">zetaH</span><span class="p">,</span> <span class="n">zetaV</span><span class="p">,</span> <span class="n">xdirect</span><span class="p">,</span> <span class="n">isfullspace</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span><span class="p">,</span>
               <span class="n">use_spline</span><span class="p">,</span> <span class="n">use_ne_eval</span><span class="p">,</span> <span class="n">msrc</span><span class="p">,</span> <span class="n">mrec</span><span class="p">,</span> <span class="n">loop_freq</span><span class="p">,</span> <span class="n">loop_off</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outdata</span></div>


<div class="viewcode-block" id="tem_input"><a class="viewcode-back" href="../../empymod.html#empymod.utils.tem_input">[docs]</a><span class="k">def</span> <span class="nf">tem_input</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">aniso</span><span class="p">,</span> <span class="n">epermH</span><span class="p">,</span> <span class="n">epermV</span><span class="p">,</span>
              <span class="n">mpermH</span><span class="p">,</span> <span class="n">mpermV</span><span class="p">,</span> <span class="n">xdirect</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ftarg</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">verb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Provide correct input for time-domain EM calculation.</span>

<span class="sd">    This check-function is called from one of the modelling routines in</span>
<span class="sd">    :mod:`model`.  Consult these modelling routines for a description of the</span>
<span class="sd">    input parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    outdata : tuple</span>
<span class="sd">        Tuple containing the correct input format for :mod:`model.tem`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check times and Fourier Transform arguments, get required frequencies</span>
    <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ftarg</span> <span class="o">=</span> <span class="n">check_time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ftarg</span><span class="p">,</span> <span class="n">verb</span><span class="p">)</span>

    <span class="c1"># Check the normal frequency-calculation stuff</span>
    <span class="n">fdata</span> <span class="o">=</span> <span class="n">fem_input</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">aniso</span><span class="p">,</span> <span class="n">epermH</span><span class="p">,</span> <span class="n">epermV</span><span class="p">,</span>
                      <span class="n">mpermH</span><span class="p">,</span> <span class="n">mpermV</span><span class="p">,</span> <span class="n">xdirect</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span><span class="p">,</span> <span class="n">opt</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">verb</span><span class="p">)</span>

    <span class="c1"># If verbose, indicate f-&gt;t transform</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&gt;  f-&gt;t TRANSFORM&quot;</span><span class="p">)</span>

    <span class="c1"># Arrange outdata-tuple</span>
    <span class="n">outdata</span> <span class="o">=</span> <span class="n">fdata</span><span class="p">[:</span><span class="mi">19</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ftarg</span><span class="p">)</span> <span class="o">+</span> <span class="n">fdata</span><span class="p">[</span><span class="mi">19</span><span class="p">:]</span>

    <span class="k">return</span> <span class="n">outdata</span></div>


<div class="viewcode-block" id="check_ab"><a class="viewcode-back" href="../../empymod.html#empymod.utils.check_ab">[docs]</a><span class="k">def</span> <span class="nf">check_ab</span><span class="p">(</span><span class="n">ab</span><span class="p">,</span> <span class="n">verb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check source-receiver configuration.</span>

<span class="sd">    This check-function is called from one of the modelling routines in</span>
<span class="sd">    :mod:`model`.  Consult these modelling routines for a description of the</span>
<span class="sd">    input parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ab_calc : int</span>
<span class="sd">        Adjusted configuration using reciprocity.</span>
<span class="sd">    msrc : bool</span>
<span class="sd">        If True, src is magnetic; if False, src is electric.</span>
<span class="sd">    mrec : bool</span>
<span class="sd">        If True, rec is magnetic; if False, rec is electric.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Try to cast ab into an integer</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="nb">int</span><span class="p">(</span><span class="n">ab</span><span class="p">)</span>
    <span class="k">except</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* ERROR   :: &lt;ab&gt; must be an integer&#39;</span><span class="p">)</span>
        <span class="k">raise</span>

    <span class="c1"># Check src and rec orientation (&lt;ab&gt; for alpha-beta)</span>
    <span class="c1"># pab: all possible values that &lt;ab&gt; can take</span>
    <span class="n">pab</span> <span class="o">=</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>
           <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span>
           <span class="mi">51</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">ab</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pab</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* ERROR   :: &lt;ab&gt; must be one of: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pab</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;;&#39;</span> <span class="o">+</span>
              <span class="s1">&#39; &lt;ab&gt; provided: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ab</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ab&#39;</span><span class="p">)</span>

    <span class="c1"># Print input &lt;ab&gt;</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Input ab    : &quot;</span><span class="p">,</span> <span class="n">ab</span><span class="p">)</span>

    <span class="c1"># Check if src and rec are magnetic or electric</span>
    <span class="n">msrc</span> <span class="o">=</span> <span class="n">ab</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">&gt;</span> <span class="mi">3</span>   <span class="c1"># If True: magnetic src</span>
    <span class="n">mrec</span> <span class="o">=</span> <span class="n">ab</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">&gt;</span> <span class="mi">3</span>  <span class="c1"># If True: magnetic rec</span>

    <span class="c1"># If rec is magnetic, switch &lt;ab&gt; using reciprocity.</span>
    <span class="k">if</span> <span class="n">mrec</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">msrc</span><span class="p">:</span>
            <span class="c1"># G^mm_ab(s, r, e, z) = -G^ee_ab(s, r, -z, -e)</span>
            <span class="n">ab_calc</span> <span class="o">=</span> <span class="n">ab</span><span class="o">-</span><span class="mi">33</span>  <span class="c1"># -30 : mrec-&gt;erec; -3: msrc-&gt;esrc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># G^me_ab(s, r, e, z) = -G^em_ba(r, s, e, z)</span>
            <span class="n">ab_calc</span> <span class="o">=</span> <span class="n">ab</span> <span class="o">%</span> <span class="mi">10</span><span class="o">*</span><span class="mi">10</span> <span class="o">+</span> <span class="n">ab</span> <span class="o">//</span> <span class="mi">10</span>  <span class="c1"># Swap alpha/beta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ab_calc</span> <span class="o">=</span> <span class="n">ab</span>

    <span class="c1"># Print actual calculated &lt;ab&gt;</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Calc. ab    : &quot;</span><span class="p">,</span> <span class="n">ab_calc</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ab_calc</span><span class="p">,</span> <span class="n">msrc</span><span class="p">,</span> <span class="n">mrec</span></div>


<div class="viewcode-block" id="check_param"><a class="viewcode-back" href="../../empymod.html#empymod.utils.check_param">[docs]</a><span class="k">def</span> <span class="nf">check_param</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">aniso</span><span class="p">,</span> <span class="n">epermH</span><span class="p">,</span> <span class="n">epermV</span><span class="p">,</span> <span class="n">mpermH</span><span class="p">,</span> <span class="n">mpermV</span><span class="p">,</span> <span class="n">verb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check depth and corresponding layer parameters.</span>

<span class="sd">    This check-function is called from one of the modelling routines in</span>
<span class="sd">    :mod:`model`.  Consult these modelling routines for a description of the</span>
<span class="sd">    input parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    depth : array</span>
<span class="sd">        Depths of layer interfaces, adds -infty at beginning if not present.</span>
<span class="sd">    res : array</span>
<span class="sd">        Resistivities as provided, checked for size.</span>
<span class="sd">    aniso, epermH, epermV, mpermH, mpermV : array</span>
<span class="sd">        Parameters as provided, checked for size. If None provided, defaults to</span>
<span class="sd">        an array of ones.</span>
<span class="sd">    isfullspace : bool</span>
<span class="sd">        If True, the model is a fullspace (res, aniso, epermH, epermV, mpermM,</span>
<span class="sd">        and mpermV are in all layers the same).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check depth</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">depth</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Ensure depth is increasing</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">depth</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">depth</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* ERROR   :: &lt;depth&gt; must be increasing;&#39;</span> <span class="o">+</span>
              <span class="s1">&#39; &lt;depth&gt; provided: &#39;</span> <span class="o">+</span> <span class="n">strvar</span><span class="p">(</span><span class="n">depth</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ab&#39;</span><span class="p">)</span>

    <span class="c1"># Add -infty at start, if not present yet</span>
    <span class="c1"># =&gt; The top-layer (-infty to first interface) is layer 0.</span>
    <span class="k">if</span> <span class="n">depth</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">infty</span><span class="p">,</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="n">depth</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">infty</span><span class="p">:</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">infty</span><span class="p">]),</span> <span class="n">depth</span><span class="p">))</span>

    <span class="c1"># Check resistivity</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Check anisotropy, electric permittivity, and magnetic permeability</span>
    <span class="c1"># =&gt; They all default to ones if not provided</span>
    <span class="k">def</span> <span class="nf">check_inp</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Param-check function.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">var</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">depth</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

    <span class="n">aniso</span> <span class="o">=</span> <span class="n">check_inp</span><span class="p">(</span><span class="n">aniso</span><span class="p">,</span> <span class="s1">&#39;aniso&#39;</span><span class="p">)</span>
    <span class="n">epermH</span> <span class="o">=</span> <span class="n">check_inp</span><span class="p">(</span><span class="n">epermH</span><span class="p">,</span> <span class="s1">&#39;epermH&#39;</span><span class="p">)</span>
    <span class="n">epermV</span> <span class="o">=</span> <span class="n">check_inp</span><span class="p">(</span><span class="n">epermV</span><span class="p">,</span> <span class="s1">&#39;epermV&#39;</span><span class="p">)</span>
    <span class="n">mpermH</span> <span class="o">=</span> <span class="n">check_inp</span><span class="p">(</span><span class="n">mpermH</span><span class="p">,</span> <span class="s1">&#39;mpermH&#39;</span><span class="p">)</span>
    <span class="n">mpermV</span> <span class="o">=</span> <span class="n">check_inp</span><span class="p">(</span><span class="n">mpermV</span><span class="p">,</span> <span class="s1">&#39;mpermV&#39;</span><span class="p">)</span>

    <span class="c1"># Print model parameters</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   depth   [m] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">depth</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   res [Ohm.m] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">res</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   aniso   [-] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">aniso</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   epermH  [-] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">epermH</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   epermV  [-] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">epermV</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   mpermH  [-] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">mpermH</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   mpermV  [-] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">mpermV</span><span class="p">))</span>

    <span class="c1"># Check if medium is a homogeneous full-space. If that is the case, the</span>
    <span class="c1"># EM-field is computed analytically directly in the frequency-domain.</span>
    <span class="c1"># Note: Also a stack of layers with the same material parameters is treated</span>
    <span class="c1">#       as a homogeneous full-space.</span>
    <span class="k">if</span> <span class="n">res</span><span class="o">.</span><span class="n">shape</span> <span class="o">==</span> <span class="p">():</span>
        <span class="n">isfullspace</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">isores</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span> <span class="o">-</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">aniso</span> <span class="o">-</span> <span class="n">aniso</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">isoeph</span> <span class="o">=</span> <span class="p">(</span><span class="n">epermH</span> <span class="o">-</span> <span class="n">epermH</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">isoepv</span> <span class="o">=</span> <span class="p">(</span><span class="n">epermV</span> <span class="o">-</span> <span class="n">epermV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">isomph</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpermH</span> <span class="o">-</span> <span class="n">mpermH</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">isompv</span> <span class="o">=</span> <span class="p">(</span><span class="n">mpermV</span> <span class="o">-</span> <span class="n">mpermV</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">isfullspace</span> <span class="o">=</span> <span class="n">isores</span><span class="o">*</span><span class="n">isoeph</span><span class="o">*</span><span class="n">isoepv</span><span class="o">*</span><span class="n">isomph</span><span class="o">*</span><span class="n">isompv</span>

    <span class="k">return</span> <span class="n">depth</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">aniso</span><span class="p">,</span> <span class="n">epermH</span><span class="p">,</span> <span class="n">epermV</span><span class="p">,</span> <span class="n">mpermH</span><span class="p">,</span> <span class="n">mpermV</span><span class="p">,</span> <span class="n">isfullspace</span></div>


<div class="viewcode-block" id="check_spatial"><a class="viewcode-back" href="../../empymod.html#empymod.utils.check_spatial">[docs]</a><span class="k">def</span> <span class="nf">check_spatial</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="n">rec</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">verb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check spatial input parameters.</span>

<span class="sd">    This check-function is called from one of the modelling routines in</span>
<span class="sd">    :mod:`model`.  Consult these modelling routines for a description of the</span>
<span class="sd">    input parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    zsrc : float</span>
<span class="sd">        Depth of src.</span>
<span class="sd">    zrec : float</span>
<span class="sd">        Depth of rec.</span>
<span class="sd">    lsrc : int</span>
<span class="sd">        Layer number in which src resides.</span>
<span class="sd">    lrec : int</span>
<span class="sd">        Layer number in which rec resides.</span>
<span class="sd">    xco : array of floats</span>
<span class="sd">        x-coordinates</span>
<span class="sd">    yco : array of floats</span>
<span class="sd">        y-coordinates</span>
<span class="sd">    off : array of floats</span>
<span class="sd">        Offsets</span>
<span class="sd">    angle : array of floats</span>
<span class="sd">        Angles</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check src</span>
    <span class="n">src</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">src</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="s1">&#39;src&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="s1">&#39;src-x&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="s1">&#39;src-y&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;src-z&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">zsrc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Check rec</span>
    <span class="n">rec</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="s1">&#39;rec&#39;</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;rec-x&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="s1">&#39;rec-y&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;rec-z&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
    <span class="n">zrec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># Determine layers in which src and rec reside.</span>
    <span class="c1"># Note: If src[2] or rec[2] are on a layer interface, the layer above the</span>
    <span class="c1">#       interface is chosen.</span>
    <span class="n">depthinfty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">depth</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">infty</span><span class="p">])))</span>
    <span class="n">lsrc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">depthinfty</span> <span class="o">&gt;=</span> <span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lrec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">depthinfty</span> <span class="o">&gt;=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># Coordinates</span>
    <span class="n">xco</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>             <span class="c1"># X-coordinates  [m]</span>
    <span class="n">yco</span> <span class="o">=</span> <span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>             <span class="c1"># Y-coordinates  [m]</span>
    <span class="n">off</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xco</span><span class="o">*</span><span class="n">xco</span> <span class="o">+</span> <span class="n">yco</span><span class="o">*</span><span class="n">yco</span><span class="p">)</span>  <span class="c1"># Offset         [m]</span>
    <span class="n">angle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">yco</span><span class="p">,</span> <span class="n">xco</span><span class="p">)</span>      <span class="c1"># Angle        [rad]</span>

    <span class="c1"># Minimum offset to avoid singularities at off = 0 m.</span>
    <span class="c1"># =&gt; min_off is defined at the start of this file</span>
    <span class="n">ioff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">off</span> <span class="o">&lt;</span> <span class="n">min_off</span><span class="p">)</span>
    <span class="n">off</span><span class="p">[</span><span class="n">ioff</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_off</span>
    <span class="n">angle</span><span class="p">[</span><span class="n">ioff</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ioff</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* WARNING :: Offsets &lt;&#39;</span><span class="p">,</span> <span class="n">min_off</span><span class="p">,</span> <span class="s1">&#39;m are set to&#39;</span><span class="p">,</span> <span class="n">min_off</span><span class="p">,</span> <span class="s1">&#39;m!&#39;</span><span class="p">)</span>

    <span class="c1"># Print spatial parameters</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   src x   [m] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   src y   [m] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   src z   [m] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   rec x   [m] : &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
              <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="s2">&quot; [min-max; #]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;               : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   rec y   [m] : &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span>
              <span class="s2">&quot;;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="s2">&quot; [min-max; #]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;               : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   rec z   [m] : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">zsrc</span><span class="p">,</span> <span class="n">zrec</span><span class="p">,</span> <span class="n">lsrc</span><span class="p">,</span> <span class="n">lrec</span><span class="p">,</span> <span class="n">xco</span><span class="p">,</span> <span class="n">yco</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">angle</span></div>


<div class="viewcode-block" id="check_hankel"><a class="viewcode-back" href="../../empymod.html#empymod.utils.check_hankel">[docs]</a><span class="k">def</span> <span class="nf">check_hankel</span><span class="p">(</span><span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span><span class="p">,</span> <span class="n">ab</span><span class="p">,</span> <span class="n">verb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check Hankel transform parameters.</span>

<span class="sd">    This check-function is called from one of the modelling routines in</span>
<span class="sd">    :mod:`model`.  Consult these modelling routines for a description of the</span>
<span class="sd">    input parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ht, htarg</span>
<span class="sd">        Checked if valid and set to defaults if not provided.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Ensure ht is all lowercase</span>
    <span class="n">ht</span> <span class="o">=</span> <span class="n">ht</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ht</span> <span class="o">==</span> <span class="s1">&#39;fht&#39;</span><span class="p">:</span>    <span class="c1"># If FHT, check filter settings</span>

        <span class="c1"># Check Input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">htarg</span><span class="p">:</span>  <span class="c1"># If None, create empty list</span>
            <span class="n">htarg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">htarg</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>  <span class="c1"># If only filter</span>
            <span class="n">htarg</span> <span class="o">=</span> <span class="p">[</span><span class="n">htarg</span><span class="p">,</span> <span class="p">]</span>

        <span class="c1"># Check filter; defaults to key_401_2009</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fhtfilt</span> <span class="o">=</span> <span class="n">htarg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fhtfilt</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">key_401_2009</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If not already filter-instance, get it from string</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fhtfilt</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">):</span>
                <span class="n">fhtfilt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">fhtfilt</span><span class="p">)()</span>

        <span class="c1"># Check pts_per_dec; defaults to None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="n">htarg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pts_per_dec</span><span class="p">:</span>  <span class="c1"># Check pts_per_dec</span>
                <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">pts_per_dec</span><span class="p">,</span> <span class="p">(),</span>
                                          <span class="s1">&#39;fht: pts_per_dec&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Assemble htarg</span>
        <span class="n">htarg</span> <span class="o">=</span> <span class="p">(</span><span class="n">fhtfilt</span><span class="p">,</span> <span class="n">pts_per_dec</span><span class="p">)</span>

        <span class="c1"># If verbose, print Hankel transform information</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Hankel      :  Fast Hankel Transform&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; Filter  :  &quot;</span> <span class="o">+</span> <span class="n">fhtfilt</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ht</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;qwe&#39;</span><span class="p">]:</span>
        <span class="c1"># Rename ht</span>
        <span class="n">ht</span> <span class="o">=</span> <span class="s1">&#39;hqwe&#39;</span>

        <span class="c1"># Get and check input or set defaults</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">htarg</span><span class="p">:</span>
            <span class="n">htarg</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># rtol : 1e-12 is low for accurate results</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rtol</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: rtol&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rtol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>

        <span class="c1"># atol : 1e-30 is low for accurate results</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">atol</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: atol&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">atol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">30</span><span class="p">)</span>

        <span class="c1"># nquad : 51 is relatively high</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">nquad</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: nquad&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">nquad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">51</span><span class="p">)</span>

        <span class="c1"># maxint :  40/100 is relatively high</span>
        <span class="c1">#             40 : 11-15, 21-25, 33-35, 41-45, 51-55</span>
        <span class="c1">#            100 : 16/26, 31/32, 46/56, 61-66</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">maxint</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: maxint&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ab</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span> <span class="mi">66</span><span class="p">]:</span>
                <span class="n">maxint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">maxint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">40</span><span class="p">)</span>

        <span class="c1"># pts_per_dec : 80 is relatively high</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: pts_per_dec&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">80</span><span class="p">)</span>

        <span class="c1"># Assemble htarg</span>
        <span class="n">htarg</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="p">,</span> <span class="n">nquad</span><span class="p">,</span> <span class="n">maxint</span><span class="p">,</span> <span class="n">pts_per_dec</span><span class="p">)</span>

        <span class="c1"># If verbose, print Hankel transform information</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Hankel      :  Quadrature-with-Extrapolation&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; rtol    :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; atol    :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; nquad   :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; maxint  :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* ERROR   :: &lt;ht&gt; must be one of: [&#39;fht&#39;, &#39;qwe&#39;];&quot;</span> <span class="o">+</span>
              <span class="s2">&quot; &lt;ht&gt; provided: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ht</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ht&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span></div>


<div class="viewcode-block" id="check_frequency"><a class="viewcode-back" href="../../empymod.html#empymod.utils.check_frequency">[docs]</a><span class="k">def</span> <span class="nf">check_frequency</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">aniso</span><span class="p">,</span> <span class="n">epermH</span><span class="p">,</span> <span class="n">epermV</span><span class="p">,</span> <span class="n">mpermH</span><span class="p">,</span> <span class="n">mpermV</span><span class="p">,</span> <span class="n">verb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calculate frequency-dependent parameters.</span>

<span class="sd">    This check-function is called from one of the modelling routines in</span>
<span class="sd">    :mod:`model`.  Consult these modelling routines for a description of the</span>
<span class="sd">    input parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    freq : float</span>
<span class="sd">        Frequency, checked for size and assured min_freq.</span>
<span class="sd">    etaH, etaV, zetaH, zetaV : array</span>
<span class="sd">        Parameters etaH, etaV, zetaH, and zetaV, same size as provided</span>
<span class="sd">        resistivity.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check frequency</span>
    <span class="n">freq</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;freq&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Minimum frequency to avoid division by zero at freq = 0 Hz.</span>
    <span class="c1"># =&gt; min_freq is defined at the start of this file</span>
    <span class="n">ifreq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">min_freq</span><span class="p">)</span>
    <span class="n">freq</span><span class="p">[</span><span class="n">ifreq</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_freq</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ifreq</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* WARNING :: Frequencies &lt;&#39;</span><span class="p">,</span> <span class="n">min_freq</span><span class="p">,</span> <span class="s1">&#39;Hz are set to&#39;</span><span class="p">,</span>
              <span class="n">min_freq</span><span class="p">,</span> <span class="s1">&#39;Hz!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   freq   [Hz] : &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span>
              <span class="nb">str</span><span class="p">(</span><span class="n">freq</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="s2">&quot; [min-max; #]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;               : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">freq</span><span class="p">))</span>

    <span class="c1"># Calculate eta and zeta (horizontal and vertical)</span>
    <span class="n">etaH</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">res</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="p">,</span> <span class="n">epermH</span><span class="o">*</span><span class="n">epsilon_0</span><span class="p">)</span>
    <span class="n">etaV</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">res</span><span class="o">*</span><span class="n">aniso</span><span class="o">*</span><span class="n">aniso</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="p">,</span> <span class="n">epermV</span><span class="o">*</span><span class="n">epsilon_0</span><span class="p">)</span>
    <span class="n">zetaH</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="p">,</span> <span class="n">mpermH</span><span class="o">*</span><span class="n">mu_0</span><span class="p">)</span>
    <span class="n">zetaV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="p">,</span> <span class="n">mpermV</span><span class="o">*</span><span class="n">mu_0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">freq</span><span class="p">,</span> <span class="n">etaH</span><span class="p">,</span> <span class="n">etaV</span><span class="p">,</span> <span class="n">zetaH</span><span class="p">,</span> <span class="n">zetaV</span></div>


<div class="viewcode-block" id="check_opt"><a class="viewcode-back" href="../../empymod.html#empymod.utils.check_opt">[docs]</a><span class="k">def</span> <span class="nf">check_opt</span><span class="p">(</span><span class="n">opt</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">ht</span><span class="p">,</span> <span class="n">htarg</span><span class="p">,</span> <span class="n">verb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check optimization parameters.</span>

<span class="sd">    This check-function is called from one of the modelling routines in</span>
<span class="sd">    :mod:`model`.  Consult these modelling routines for a description of the</span>
<span class="sd">    input parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    use_spline : bool</span>
<span class="sd">        Boolean if to use spline interpolation.</span>
<span class="sd">    use_ne_eval : bool</span>
<span class="sd">        Boolean if to use `numexpr`.</span>
<span class="sd">    loop_freq : bool</span>
<span class="sd">        Boolean if to loop over frequencies.</span>
<span class="sd">    loop_off : bool</span>
<span class="sd">        Boolean if to loop over offsets.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check optimization flag</span>
    <span class="k">if</span> <span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;spline&#39;</span><span class="p">:</span>
        <span class="n">use_spline</span><span class="p">,</span> <span class="n">use_ne_eval</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">opt</span> <span class="o">==</span> <span class="s1">&#39;parallel&#39;</span><span class="p">:</span>
        <span class="n">use_spline</span><span class="p">,</span> <span class="n">use_ne_eval</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">use_spline</span><span class="p">,</span> <span class="n">use_ne_eval</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>

    <span class="c1"># Define if to loop over frequencies or over offsets</span>
    <span class="k">if</span> <span class="n">ht</span> <span class="o">==</span> <span class="s1">&#39;hqwe&#39;</span> <span class="ow">or</span> <span class="n">use_spline</span><span class="p">:</span>
        <span class="n">loop_freq</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">loop_off</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">loop_off</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">==</span> <span class="s1">&#39;off&#39;</span>
        <span class="n">loop_freq</span> <span class="o">=</span> <span class="n">loop</span> <span class="o">==</span> <span class="s1">&#39;freq&#39;</span>

    <span class="c1"># If verbose, print optimization information</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">use_spline</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Hankel Opt. :  Use spline&quot;</span><span class="p">)</span>
            <span class="n">pstr</span> <span class="o">=</span> <span class="s2">&quot;     &gt; pts/dec :  &quot;</span>
            <span class="k">if</span> <span class="n">ht</span> <span class="o">==</span> <span class="s1">&#39;hqwe&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">pstr</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">htarg</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">pstr</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">htarg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">pstr</span> <span class="o">+</span> <span class="s1">&#39;Defined by filter (lagged)&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">use_ne_eval</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Hankel Opt. :  Use parallel&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Hankel Opt. :  None&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">loop_off</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Loop over   :  Offsets&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">loop_freq</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Loop over   :  Frequencies&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Loop over   :  None (all vectorized)&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">use_spline</span><span class="p">,</span> <span class="n">use_ne_eval</span><span class="p">,</span> <span class="n">loop_freq</span><span class="p">,</span> <span class="n">loop_off</span></div>


<div class="viewcode-block" id="check_time"><a class="viewcode-back" href="../../empymod.html#empymod.utils.check_time">[docs]</a><span class="k">def</span> <span class="nf">check_time</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ftarg</span><span class="p">,</span> <span class="n">verb</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Check time domain specific input parameters.</span>

<span class="sd">    This check-function is called from one of the modelling routines in</span>
<span class="sd">    :mod:`model`.  Consult these modelling routines for a description of the</span>
<span class="sd">    input parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    time : float</span>
<span class="sd">        Time, checked for size and assured min_time.</span>
<span class="sd">    freq : float</span>
<span class="sd">        Frequencies required for given times and ft-settings.</span>
<span class="sd">    ft, ftarg</span>
<span class="sd">        Checked if valid and set to defaults if not provided,</span>
<span class="sd">        checked with signal.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check time</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>

    <span class="c1"># Minimum time to avoid division by zero  at time = 0 s.</span>
    <span class="c1"># =&gt; min_time is defined at the start of this file</span>
    <span class="n">itime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">time</span> <span class="o">&lt;</span> <span class="n">min_time</span><span class="p">)</span>
    <span class="n">time</span><span class="p">[</span><span class="n">itime</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_time</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">itime</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* WARNING :: Times &lt;&#39;</span><span class="p">,</span> <span class="n">min_time</span><span class="p">,</span> <span class="s1">&#39;s are set to&#39;</span><span class="p">,</span> <span class="n">min_time</span><span class="p">,</span> <span class="s1">&#39;s!&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   time    [s] : &quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()),</span> <span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()),</span> <span class="s2">&quot;;&quot;</span><span class="p">,</span>
              <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> <span class="s2">&quot; [min-max; #]&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;               : &quot;</span><span class="p">,</span> <span class="n">strvar</span><span class="p">(</span><span class="n">time</span><span class="p">))</span>

    <span class="c1"># Ensure ft is all lowercase</span>
    <span class="n">ft</span> <span class="o">=</span> <span class="n">ft</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">ft</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cos&#39;</span><span class="p">,</span> <span class="s1">&#39;sin&#39;</span><span class="p">]:</span>    <span class="c1"># If Cosine/Sine, check filter setting</span>

        <span class="c1"># If switch-off/on is required, ensure ft is sine</span>
        <span class="c1"># Sine-transform uses imaginary part, which is 0 at DC (-&gt; late time)</span>
        <span class="k">if</span> <span class="n">signal</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">ft</span> <span class="o">=</span> <span class="s1">&#39;sin&#39;</span>

        <span class="c1"># Check Input</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ftarg</span><span class="p">:</span>  <span class="c1"># If None, create empty list</span>
            <span class="n">ftarg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ftarg</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>  <span class="c1"># If only filter</span>
            <span class="n">ftarg</span> <span class="o">=</span> <span class="p">[</span><span class="n">ftarg</span><span class="p">,</span> <span class="p">]</span>

        <span class="c1"># Check filter; defaults to key_201_CosSin_2012</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fftfilt</span> <span class="o">=</span> <span class="n">ftarg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">fftfilt</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">key_201_CosSin_2012</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If not already filters-instance, get it from string</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fftfilt</span><span class="p">,</span> <span class="s1">&#39;base&#39;</span><span class="p">):</span>
                <span class="n">fftfilt</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="n">fftfilt</span><span class="p">)()</span>

        <span class="c1"># Check pts_per_dec; defaults to None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="n">ftarg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pts_per_dec</span><span class="p">:</span>  <span class="c1"># Check pts_per_dec</span>
                <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">pts_per_dec</span><span class="p">,</span> <span class="p">(),</span>
                                          <span class="n">ft</span> <span class="o">+</span> <span class="s1">&#39;: pts_per_dec&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>

        <span class="c1"># Assemble ftarg</span>
        <span class="n">ftarg</span> <span class="o">=</span> <span class="p">(</span><span class="n">fftfilt</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">pts_per_dec</span><span class="p">)</span>

        <span class="c1"># If verbose, print Fourier transform information</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ft</span> <span class="o">==</span> <span class="s1">&#39;sin&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Fourier     :  Sine-Filter&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Fourier     :  Cosine-Filter&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; Filter  :  &quot;</span> <span class="o">+</span> <span class="n">ftarg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">pstr</span> <span class="o">=</span> <span class="s2">&quot;     &gt; pts/dec :  &quot;</span>
            <span class="k">if</span> <span class="n">ftarg</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">pstr</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">pstr</span> <span class="o">+</span> <span class="s1">&#39;Defined by filter (lagged)&#39;</span><span class="p">)</span>

        <span class="c1"># Get required frequencies</span>
        <span class="c1"># (multiply time by 2Pi, as calculation is done in angular frequencies)</span>
        <span class="n">freq</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">get_spline_values</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">time</span><span class="p">,</span> <span class="n">ftarg</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Rename ft</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="s1">&#39;fft&#39;</span>

    <span class="k">elif</span> <span class="n">ft</span> <span class="o">==</span> <span class="s1">&#39;qwe&#39;</span><span class="p">:</span>    <span class="c1"># QWE</span>
        <span class="c1"># Rename ft</span>
        <span class="n">ft</span> <span class="o">=</span> <span class="s1">&#39;fqwe&#39;</span>

        <span class="c1"># Get and check input or set defaults</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ftarg</span><span class="p">:</span>  <span class="c1"># Default values</span>
            <span class="n">ftarg</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># rtol</span>
            <span class="n">rtol</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: rtol&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">rtol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">8</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># atol</span>
            <span class="n">atol</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: atol&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">atol</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="mi">1</span><span class="n">e</span><span class="o">-</span><span class="mi">20</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># nquad</span>
            <span class="n">nquad</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: nquad&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">nquad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">21</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># maxint</span>
            <span class="n">maxint</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: maxint&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">maxint</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">200</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># pts_per_dec</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;qwe: pts_per_dec&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span>

        <span class="c1"># Assemble ftarg</span>
        <span class="n">ftarg</span> <span class="o">=</span> <span class="p">(</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="p">,</span> <span class="n">nquad</span><span class="p">,</span> <span class="n">maxint</span><span class="p">,</span> <span class="n">pts_per_dec</span><span class="p">)</span>

        <span class="c1"># If verbose, print Fourier transform information</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Fourier      :  Quadrature-with-Extrapolation&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; rtol    :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; atol    :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; nquad   :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; maxint  :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; pts/dec :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">4</span><span class="p">]))</span>

        <span class="c1"># Get required frequencies</span>
        <span class="n">g_x</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">get_Gauss_Weights</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">minf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="n">g_x</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="o">/</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span><span class="o">/</span><span class="mi">10</span>
        <span class="n">maxf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">()))</span><span class="o">/</span><span class="mi">10</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">minf</span><span class="p">,</span> <span class="n">maxf</span><span class="p">,</span> <span class="p">(</span><span class="n">maxf</span><span class="o">-</span><span class="n">minf</span><span class="p">)</span><span class="o">*</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ft</span> <span class="o">==</span> <span class="s1">&#39;fftlog&#39;</span><span class="p">:</span>    <span class="c1"># FFTLog</span>

        <span class="c1"># Get and check input or set defaults</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ftarg</span><span class="p">:</span>  <span class="c1"># Default values</span>
            <span class="n">ftarg</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># pts_per_dec</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;fftlog: pts_per_dec&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">pts_per_dec</span> <span class="o">=</span> <span class="mi">10</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># add_dec</span>
            <span class="n">add_dec</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="mi">2</span><span class="p">,),</span> <span class="s1">&#39;fftlog: add_dec&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">add_dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="k">try</span><span class="p">:</span>  <span class="c1"># q</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">param_shape</span><span class="p">(</span><span class="n">ftarg</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(),</span> <span class="s1">&#39;fftlog: q&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span>
            <span class="c1"># Restrict q to +/- 1</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># If verbose, print Fourier transform information</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;   Fourier      :  FFTLog &quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; pts/dec  :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pts_per_dec</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; add_dec  :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">add_dec</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;     &gt; q        :  &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>

        <span class="c1"># Calculate minimum and maximum required frequency</span>
        <span class="n">minf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">time</span><span class="o">.</span><span class="n">max</span><span class="p">())</span> <span class="o">+</span> <span class="n">add_dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">maxf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">time</span><span class="o">.</span><span class="n">min</span><span class="p">())</span> <span class="o">+</span> <span class="n">add_dec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">maxf</span> <span class="o">-</span> <span class="n">minf</span><span class="p">)</span><span class="o">*</span><span class="n">pts_per_dec</span>

        <span class="c1"># Initialize FFTLog, get required parameters</span>
        <span class="n">freq</span><span class="p">,</span> <span class="n">tcalc</span><span class="p">,</span> <span class="n">dlnr</span><span class="p">,</span> <span class="n">kr</span><span class="p">,</span> <span class="n">rk</span> <span class="o">=</span> <span class="n">transform</span><span class="o">.</span><span class="n">fhti</span><span class="p">(</span><span class="n">minf</span><span class="p">,</span> <span class="n">maxf</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

        <span class="c1"># Assemble ftarg</span>
        <span class="n">ftarg</span> <span class="o">=</span> <span class="p">(</span><span class="n">tcalc</span><span class="p">,</span> <span class="n">dlnr</span><span class="p">,</span> <span class="n">kr</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;* ERROR   :: &lt;ft&gt; must be one of: [&#39;cos&#39;, &#39;sin&#39;, &#39;qwe&#39;, &quot;</span> <span class="o">+</span>
              <span class="s2">&quot;&#39;fftlog&#39;]; &lt;ft&gt; provided: &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">ft</span><span class="p">))</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;ft&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">time</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="n">freq</span><span class="p">,</span> <span class="n">ft</span><span class="p">,</span> <span class="n">ftarg</span></div>


<span class="c1"># 3. General utilities</span>

<div class="viewcode-block" id="strvar"><a class="viewcode-back" href="../../empymod.html#empymod.utils.strvar">[docs]</a><span class="k">def</span> <span class="nf">strvar</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">prec</span><span class="o">=</span><span class="s1">&#39;</span><span class="si">{:G}</span><span class="s1">&#39;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return variable as a string to print, with given precision.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array_like</span>
<span class="sd">        Variable to be printed.</span>
<span class="sd">    prec : format-str, optional</span>
<span class="sd">        Precision for variable; defaults to &#39;{:G}&#39;.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from empymod.utils import strvar</span>
<span class="sd">    &gt;&gt;&gt; print(&#39;Example : &#39; + strvar(1.23456789*np.arange(6)))</span>
<span class="sd">    Example : 0 1.23457 2.46914 3.7037 4.93827 6.17284</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">prec</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">a</span><span class="p">)])</span></div>


<div class="viewcode-block" id="param_shape"><a class="viewcode-back" href="../../empymod.html#empymod.utils.param_shape">[docs]</a><span class="k">def</span> <span class="nf">param_shape</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;inp-var&#39;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert input variable to array and check its shape.</span>

<span class="sd">    Ensures one-dimensionality except if datatype is list or tuple.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    a : array_like</span>
<span class="sd">        Input array.</span>
<span class="sd">    shape : tuple, optional</span>
<span class="sd">        Tuple of dimension that the variable should have.</span>
<span class="sd">    name : str, optional</span>
<span class="sd">        String describing variable, defaults to &#39;inp-var&#39;.</span>
<span class="sd">    datatype : type, optional</span>
<span class="sd">        Type of array.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    a : array</span>
<span class="sd">        Returns a as an array if np.shape(a) = shape; else raise error.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    &gt;&gt;&gt; import numpy as np</span>
<span class="sd">    &gt;&gt;&gt; from empymod.utils import param_shape</span>
<span class="sd">    &gt;&gt;&gt; a = [1, 2, 3]</span>
<span class="sd">    &gt;&gt;&gt; b = [1, 2]</span>
<span class="sd">    &gt;&gt;&gt; c = np.asarray(a).shape</span>
<span class="sd">    &gt;&gt;&gt; param_shape(a, c, &#39;test-A&#39;)</span>
<span class="sd">    array([1, 2, 3])</span>
<span class="sd">    &gt;&gt;&gt; param_shape(b, c, &#39;test-B&#39;)</span>
<span class="sd">    Traceback (most recent call last):</span>
<span class="sd">        ...</span>
<span class="sd">    ValueError: test-B</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Convert input to an array</span>
    <span class="k">if</span> <span class="n">datatype</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">datatype</span><span class="p">))</span>

    <span class="c1"># Ensure one-dimensionality except if datatype is int, list, or tuple</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

    <span class="c1"># Ensure a.shape is equal to shape, raise error if not</span>
    <span class="k">if</span> <span class="n">shape</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">shape</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;* ERROR   :: Parameter &#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39; has wrong shape! : &#39;</span> <span class="o">+</span>
              <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; instead of &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">a</span></div>


<div class="viewcode-block" id="printstartfinish"><a class="viewcode-back" href="../../empymod.html#empymod.utils.printstartfinish">[docs]</a><span class="k">def</span> <span class="nf">printstartfinish</span><span class="p">(</span><span class="n">verb</span><span class="p">,</span> <span class="n">inp</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Print start and finish with time measure.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">inp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">:: empymod END; runtime = &#39;</span> <span class="o">+</span>
              <span class="nb">str</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">default_timer</span><span class="p">()</span> <span class="o">-</span> <span class="n">inp</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39; ::</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t0</span> <span class="o">=</span> <span class="n">default_timer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verb</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">:: empymod START  ::</span><span class="se">\n\n</span><span class="s2">&gt;  INPUT CHECK&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">t0</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2016, Dieter Werthm√ºller.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.4.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.9</a>
      
    </div>

    

    
  </body>
</html>